<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Conversation Orchestrator</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Crimson+Text:ital,wght@0,400;0,600;0,700;1,400&family=Raleway:wght@300;400;500;600;700&family=Courier+Prime:wght@400;700&display=swap');
        
        :root {
            --primary-gradient: linear-gradient(135deg, #8B6B47 0%, #A0826D 100%);
            --secondary-gradient: linear-gradient(135deg, #D4A574 0%, #B08D57 100%);
            --accent-gradient: linear-gradient(135deg, #C19A6B 0%, #A67C52 100%);
            --warm-bg: #F5E6D3;
            --card-bg: #FAF3E9;
            --paper-bg: #FFF8F0;
            --border-color: #D4A574;
            --text-primary: #3A2317;
            --text-secondary: #6B4E3D;
            --accent-gold: #B08D57;
            --accent-bronze: #8B6B47;
            --accent-copper: #A67C52;
            --success-green: #4A6741;
            --danger-red: #8B3A3A;
            --vintage-blue: #4A5D6B;
            --vintage-purple: #6B4A5D;
        }

        * {
            box-sizing: border-box;
        }

        body {
            font-family: 'Crimson Text', serif;
            background: var(--warm-bg);
            color: var(--text-primary);
            min-height: 100vh;
            margin: 0;
            position: relative;
            overflow-x: hidden;
            font-size: 17px;
            line-height: 1.7;
        }

        /* Vintage paper texture background */
        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: 
                url("data:image/svg+xml,%3Csvg width='100' height='100' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noise'%3E%3CfeTurbulence baseFrequency='0.9' numOctaves='4' /%3E%3C/filter%3E%3Crect width='100' height='100' filter='url(%23noise)' opacity='0.02'/%3E%3C/svg%3E"),
                radial-gradient(ellipse at top, rgba(212, 165, 116, 0.1) 0%, transparent 60%),
                radial-gradient(ellipse at bottom, rgba(160, 130, 109, 0.1) 0%, transparent 60%);
            z-index: -1;
        }

        .container {
            max-width: 1200px;
            padding: 2rem;
        }

        /* Vintage paper cards */
        .glass-card {
            background: var(--card-bg);
            border: 2px solid var(--border-color);
            border-radius: 8px;
            padding: 2.5rem;
            margin-bottom: 2rem;
            box-shadow: 
                0 4px 6px rgba(139, 107, 71, 0.1),
                0 1px 3px rgba(139, 107, 71, 0.08);
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        /* Vintage corner ornaments */
        .glass-card::before {
            content: '❦';
            position: absolute;
            top: 15px;
            left: 15px;
            font-size: 1.5rem;
            color: var(--accent-gold);
            opacity: 0.3;
        }

        .glass-card::after {
            content: '❦';
            position: absolute;
            bottom: 15px;
            right: 15px;
            font-size: 1.5rem;
            color: var(--accent-gold);
            opacity: 0.3;
            transform: rotate(180deg);
        }

        .glass-card:hover {
            transform: translateY(-2px);
            box-shadow: 
                0 6px 12px rgba(139, 107, 71, 0.15),
                0 3px 6px rgba(139, 107, 71, 0.1);
        }

        /* Headers */
        h1 {
            font-family: 'Raleway', sans-serif;
            font-size: 3rem;
            font-weight: 300;
            color: var(--accent-bronze);
            text-align: center;
            margin-bottom: 1rem;
            letter-spacing: 0.08em;
            text-transform: uppercase;
            position: relative;
            padding-bottom: 1.5rem;
        }

        h1::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 50%;
            transform: translateX(-50%);
            width: 100px;
            height: 2px;
            background: var(--accent-gradient);
        }

        .subtitle {
            font-family: 'Crimson Text', serif;
            text-align: center;
            color: var(--text-secondary);
            font-size: 1.3rem;
            margin-bottom: 3rem;
            font-weight: 400;
            font-style: italic;
        }

        h2, h3, h4, h5 {
            font-family: 'Raleway', sans-serif;
            color: var(--text-primary);
            font-weight: 600;
            margin-top: 1.5rem;
        }

        h2 {
            font-size: 2rem;
        }

        h3 {
            font-size: 1.5rem;
            color: var(--accent-bronze);
        }

        /* Form controls */
        .form-control, .form-select {
            background: var(--paper-bg);
            border: 1px solid var(--border-color);
            color: var(--text-primary);
            border-radius: 4px;
            padding: 0.75rem 1rem;
            font-size: 1rem;
            font-family: 'Crimson Text', serif;
            transition: all 0.3s ease;
            box-shadow: inset 0 1px 2px rgba(139, 107, 71, 0.1);
        }

        .form-control:focus, .form-select:focus {
            background: white;
            border-color: var(--accent-bronze);
            box-shadow: 0 0 0 2px rgba(139, 107, 71, 0.1);
            color: var(--text-primary);
            outline: none;
        }

        /* Custom dropdown styling with vintage theme */
        .form-select {
            background-color: var(--paper-bg) !important;
            color: var(--text-primary) !important;
            border: 1px solid var(--border-color);
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 12 12'%3E%3Cpath fill='%238B6B47' d='M10.293 3.293L6 7.586 1.707 3.293A1 1 0 00.293 4.707l5 5a1 1 0 001.414 0l5-5a1 1 0 10-1.414-1.414z'/%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 1rem center;
            background-size: 0.8rem;
            padding-right: 2.5rem;
        }

        .form-select:focus {
            background-color: white !important;
            color: var(--text-primary) !important;
            border-color: var(--accent-bronze) !important;
        }

        /* Style dropdown options */
        .form-select option {
            background-color: var(--paper-bg) !important;
            background: var(--paper-bg) !important;
            color: var(--text-primary) !important;
            padding: 12px 16px !important;
            border: none !important;
        }

        .form-select option:hover {
            background-color: var(--accent-gold) !important;
            background: var(--accent-gold) !important;
            color: white !important;
        }

        .form-select option:checked,
        .form-select option:selected {
            background-color: var(--accent-bronze) !important;
            background: var(--accent-bronze) !important;
            color: white !important;
        }

        /* Additional styling for WebKit browsers */
        .form-select::-webkit-scrollbar {
            width: 8px;
        }

        .form-select::-webkit-scrollbar-track {
            background: var(--paper-bg);
        }

        .form-select::-webkit-scrollbar-thumb {
            background: var(--accent-bronze);
            border-radius: 4px;
        }

        /* Light theme on select dropdown */
        .form-select {
            color-scheme: light;
        }

        .form-label {
            color: var(--text-secondary);
            font-family: 'Raleway', sans-serif;
            font-weight: 600;
            margin-bottom: 0.5rem;
            font-size: 0.85rem;
            text-transform: uppercase;
            letter-spacing: 0.08em;
        }

        /* Ensure text is readable in modals */
        .modal-body {
            color: var(--text-primary);
        }

        .modal-body .form-text {
            color: var(--text-secondary) !important;
        }

        .modal-body p {
            color: var(--text-primary);
        }

        .text-danger {
            color: var(--danger-red) !important;
        }

        /* Buttons */
        .btn {
            font-family: 'Raleway', sans-serif;
            border-radius: 4px;
            padding: 0.75rem 1.5rem;
            font-weight: 600;
            transition: all 0.3s ease;
            border: 2px solid transparent;
            position: relative;
            overflow: hidden;
            text-transform: uppercase;
            letter-spacing: 0.08em;
            font-size: 0.85rem;
            box-shadow: 0 2px 4px rgba(139, 107, 71, 0.15);
        }

        .btn-primary {
            background: var(--accent-bronze);
            color: white;
            border-color: var(--accent-bronze);
        }

        .btn-primary:hover {
            background: var(--accent-gold);
            border-color: var(--accent-gold);
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(139, 107, 71, 0.2);
        }

        .btn-success {
            background: var(--success-green);
            color: white;
            border-color: var(--success-green);
        }

        .btn-success:hover {
            background: #5A7951;
            border-color: #5A7951;
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(74, 103, 65, 0.2);
        }

        .btn-danger {
            background: var(--danger-red);
            color: white;
            border-color: var(--danger-red);
        }

        .btn-danger:hover {
            background: #A04444;
            border-color: #A04444;
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(139, 58, 58, 0.2);
        }

        .btn-outline-success {
            background: transparent;
            border: 2px solid var(--success-green);
            color: var(--success-green);
        }

        .btn-outline-success:hover {
            background: var(--success-green);
            color: white;
            border-color: var(--success-green);
            box-shadow: 0 4px 8px rgba(74, 103, 65, 0.2);
        }

        .btn-secondary {
            background: transparent;
            border: 2px solid var(--text-secondary);
            color: var(--text-secondary);
        }

        .btn-secondary:hover {
            background: var(--text-secondary);
            color: white;
            border-color: var(--text-secondary);
        }

        .btn-warning {
            background: var(--accent-gold);
            color: white;
            border-color: var(--accent-gold);
        }

        .btn-warning:hover {
            background: var(--accent-copper);
            border-color: var(--accent-copper);
        }

        /* Agent cards */
        .agent-card {
            background: var(--paper-bg);
            border: 1px solid var(--border-color);
            border-radius: 6px;
            margin-bottom: 1.5rem;
            overflow: hidden;
            transition: all 0.3s ease;
            box-shadow: 0 2px 4px rgba(139, 107, 71, 0.1);
        }

        .agent-card:hover {
            border-color: var(--accent-bronze);
            box-shadow: 0 4px 8px rgba(139, 107, 71, 0.15);
        }

        .agent-card-header {
            background: linear-gradient(135deg, rgba(212, 165, 116, 0.15) 0%, rgba(176, 141, 87, 0.15) 100%);
            padding: 1.25rem;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .agent-card-body {
            padding: 1.5rem;
        }

        .agent-number {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 32px;
            height: 32px;
            background: var(--accent-bronze);
            border-radius: 50%;
            font-weight: 700;
            font-size: 0.9rem;
            margin-right: 0.75rem;
            color: white;
            font-family: 'Raleway', sans-serif;
            box-shadow: 0 2px 4px rgba(139, 107, 71, 0.2);
        }

        /* Response boxes */
        .response-box {
            background: var(--paper-bg);
            border: 1px solid var(--border-color);
            border-radius: 6px;
            padding: 2rem;
            margin-top: 1rem;
            font-family: 'Courier Prime', monospace;
            font-size: 1rem;
            line-height: 1.8;
            white-space: pre-wrap;
            color: var(--text-primary);
            position: relative;
            overflow: hidden;
            box-shadow: inset 0 1px 3px rgba(139, 107, 71, 0.1);
        }

        .response-box::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 2px;
            background: var(--accent-gradient);
        }

        /* Dev note */
        .dev-note {
            background: linear-gradient(135deg, rgba(212, 165, 116, 0.15) 0%, rgba(176, 141, 87, 0.15) 100%);
            border: 1px solid var(--accent-gold);
            color: var(--text-primary);
            padding: 1rem 1.5rem;
            border-radius: 6px;
            margin-bottom: 2rem;
            font-size: 1rem;
            display: flex;
            align-items: center;
            gap: 1rem;
            box-shadow: 0 2px 4px rgba(176, 141, 87, 0.15);
        }

        .dev-note i {
            font-size: 1.2rem;
            color: var(--accent-bronze);
        }

        /* Tooltips */
        [title] {
            position: relative;
            cursor: help;
        }

        /* Loading spinner */
        .spinner-border {
            width: 1rem;
            height: 1rem;
            border-width: 2px;
        }

        /* Scrollbar */
        ::-webkit-scrollbar {
            width: 12px;
        }

        ::-webkit-scrollbar-track {
            background: var(--warm-bg);
            border-radius: 6px;
            border: 1px solid var(--border-color);
        }

        ::-webkit-scrollbar-thumb {
            background: var(--accent-bronze);
            border-radius: 6px;
            border: 1px solid var(--accent-gold);
        }

        ::-webkit-scrollbar-thumb:hover {
            background: var(--accent-gold);
        }

        /* Developer Credit Section */
        .developer-credit {
            background: linear-gradient(135deg, rgba(212, 165, 116, 0.1) 0%, rgba(176, 141, 87, 0.1) 100%);
            border: 2px solid var(--accent-gold);
            border-radius: 8px;
            padding: 2.5rem;
            margin-bottom: 3rem;
            text-align: center;
            position: relative;
            overflow: hidden;
            box-shadow: 0 4px 8px rgba(139, 107, 71, 0.1);
        }

        .developer-credit::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 2px;
            background: var(--accent-gradient);
        }

        /* Decorative corners for developer credit */
        .developer-credit::after {
            content: '§';
            position: absolute;
            top: 15px;
            right: 15px;
            font-size: 2rem;
            color: var(--accent-gold);
            opacity: 0.3;
            font-family: 'Crimson Text', serif;
        }

        .developer-credit-content {
            position: relative;
            z-index: 1;
        }

        .developer-name {
            color: var(--accent-bronze);
            font-weight: 700;
            font-size: 1.5rem;
            margin-bottom: 1rem;
            direction: rtl;
            text-align: center;
            font-family: 'Raleway', sans-serif;
            text-transform: uppercase;
            letter-spacing: 0.1em;
        }

        .developer-message,
        .developer-feedback,
        .developer-opportunity {
            color: var(--text-primary);
            margin-bottom: 0.75rem;
            font-size: 1.1rem;
            line-height: 1.8;
            direction: rtl;
            text-align: center;
            font-family: 'Crimson Text', serif;
        }

        .developer-opportunity {
            margin-bottom: 1.5rem;
        }

        .linkedin-link {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            background: var(--vintage-blue);
            color: white;
            padding: 0.75rem 1.5rem;
            border-radius: 4px;
            text-decoration: none;
            font-weight: 600;
            font-size: 1rem;
            transition: all 0.3s ease;
            box-shadow: 0px 3px 6px rgba(74, 93, 107, 0.3);
            direction: rtl;
            font-family: 'Raleway', sans-serif;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            border: 2px solid var(--vintage-blue);
        }

        .linkedin-link:hover {
            transform: translateY(-2px);
            box-shadow: 0px 5px 10px rgba(74, 93, 107, 0.4);
            color: white;
            text-decoration: none;
            background: #5A6D7B;
            border-color: #5A6D7B;
        }

        .linkedin-link i {
            font-size: 1.2rem;
        }

        /* Section dividers */
        .section-divider {
            height: 2px;
            background: linear-gradient(to right, transparent, var(--accent-gold), transparent);
            margin: 3rem 0;
            position: relative;
        }

        .section-divider::after {
            content: '◈';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: var(--warm-bg);
            padding: 0 1rem;
            color: var(--accent-gold);
            font-size: 1.2rem;
        }

        .guide-link-banner {
            text-align: center;
            margin-bottom: 2.5rem;
        }

        .guide-link-banner a {
            background: var(--accent-gold);
            color: white;
            padding: 12px 24px;
            border-radius: 4px;
            text-decoration: none;
            font-weight: 600;
            font-size: 1rem;
            display: inline-block;
            transition: all 0.3s ease;
            box-shadow: 0px 4px 8px rgba(176, 141, 87, 0.3);
            font-family: 'Raleway', sans-serif;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            border: 2px solid var(--accent-gold);
        }

        .guide-link-banner a:hover {
            transform: translateY(-2px);
            box-shadow: 0px 6px 12px rgba(176, 141, 87, 0.4);
            color: white;
            background: var(--accent-copper);
            border-color: var(--accent-copper);
        }

        /* Guide section */
        .guide-section {
            background: var(--card-bg);
            border-radius: 8px;
            padding: 3rem;
            margin-top: 4rem;
            border: 2px solid var(--border-color);
            box-shadow: 0 4px 8px rgba(139, 107, 71, 0.1);
            position: relative;
        }

        .guide-section::before {
            content: '※';
            position: absolute;
            top: 20px;
            left: 20px;
            font-size: 2rem;
            color: var(--accent-gold);
            opacity: 0.3;
        }

        .guide-section h4 {
            color: var(--accent-bronze);
            margin-top: 2rem;
            margin-bottom: 1rem;
            font-size: 1.4rem;
        }

        .guide-section h5 {
            color: var(--vintage-purple);
            margin-top: 1.5rem;
            margin-bottom: 0.75rem;
            font-size: 1.2rem;
        }

        .guide-section h6 {
            color: var(--accent-copper);
            margin-top: 1.25rem;
            margin-bottom: 0.5rem;
            font-size: 1.1rem;
        }

        .guide-section code {
            background: rgba(139, 107, 71, 0.1);
            padding: 0.2rem 0.4rem;
            border-radius: 3px;
            font-family: 'Courier Prime', monospace;
            font-size: 0.95em;
            color: var(--accent-bronze);
        }

        .guide-section pre {
            background: var(--paper-bg);
            border: 1px solid var(--border-color);
            border-radius: 6px;
            padding: 1.5rem;
            overflow-x: auto;
            margin: 1rem 0;
            box-shadow: inset 0 1px 3px rgba(139, 107, 71, 0.1);
        }

        .guide-section pre code {
            background: none;
            padding: 0;
            color: var(--text-primary);
        }

        /* Enhanced dropdown interaction */
        .form-select:hover {
            background: white;
            border-color: var(--accent-gold);
            cursor: pointer;
        }

        /* Custom styling for dropdown when open */
        .form-select:focus-within {
            background: white;
            box-shadow: 
                0 0 0 2px rgba(139, 107, 71, 0.1),
                0 4px 8px rgba(139, 107, 71, 0.15);
        }

        /* Enhanced Response Styling */
        .formatted-response {
            font-family: 'Crimson Text', serif;
            white-space: normal;
            line-height: 1.8;
        }

        /* Simplified Agent Response Styling */
        .agent-response-block {
            margin-top: 2rem;
            padding-top: 2rem;
            border-top: 1px solid var(--border-color);
        }

        .agent-response-header {
            display: flex;
            align-items: flex-start;
            margin-bottom: 1.5rem;
        }

        .agent-response-name {
            font-size: 1.3rem;
            font-weight: 600;
            color: var(--accent-bronze);
            font-family: 'Raleway', sans-serif;
        }

        .agent-response-description {
            color: var(--text-secondary);
            font-size: 0.95rem;
            margin-top: 0.25rem;
            font-style: italic;
        }

        .agent-response-body {
            padding-left: 3.5rem; /* Aligns with text, past the icon */
        }
        
        .agent-header-text {
            display: flex;
            flex-direction: column;
        }

        /* Dialogue Styling */
        .dialogue-section {
            background: rgba(212, 165, 116, 0.1);
            border-radius: 6px;
            padding: 1.5rem;
            margin: 1.5rem 0;
            border: 1px solid var(--border-color);
        }

        .dialogue-line {
            margin-bottom: 1rem;
            display: flex;
            align-items: flex-start;
            gap: 1rem;
        }

        .dialogue-speaker {
            font-weight: 600;
            color: var(--vintage-blue);
            min-width: 100px;
            text-align: right;
            font-family: 'Raleway', sans-serif;
        }

        .dialogue-text {
            flex: 1;
            color: var(--text-primary);
            background: var(--paper-bg);
            padding: 0.75rem 1rem;
            border-radius: 4px;
            border-left: 3px solid var(--vintage-blue);
            font-style: italic;
        }

        /* Section Separator */
        .conversation-separator {
            height: 2px;
            background: linear-gradient(to right, transparent, var(--accent-gold), transparent);
            margin: 2rem 0;
            position: relative;
        }

        .conversation-separator::after {
            content: '❦';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: var(--warm-bg);
            padding: 0 1rem;
            color: var(--accent-gold);
            font-size: 1.5rem;
        }

        /* Code Block Styling */
        .formatted-code-block {
            background: var(--paper-bg);
            border: 1px solid var(--border-color);
            border-radius: 4px;
            padding: 1rem;
            margin: 1rem 0;
            overflow-x: auto;
            box-shadow: inset 0 1px 3px rgba(139, 107, 71, 0.1);
        }

        .formatted-code-block code {
            font-family: 'Courier Prime', monospace;
            font-size: 0.95rem;
            color: var(--text-primary);
            line-height: 1.6;
        }

        /* Inline Code */
        .formatted-response code {
            background: rgba(139, 107, 71, 0.1);
            padding: 0.2rem 0.4rem;
            border-radius: 3px;
            font-family: 'Courier Prime', monospace;
            font-size: 0.95em;
            color: var(--accent-bronze);
        }

        /* Lists */
        .formatted-response ol, .formatted-response ul {
            margin: 1rem 0;
            padding-left: 2rem;
        }

        .formatted-response li {
            margin-bottom: 0.5rem;
            color: var(--text-primary);
        }

        /* Strong text */
        .formatted-response strong {
            color: var(--accent-bronze);
            font-weight: 700;
        }

        /* Warning/Info boxes */
        .info-box {
            background: rgba(74, 93, 107, 0.1);
            border: 1px solid var(--vintage-blue);
            border-radius: 4px;
            padding: 1rem;
            margin: 1rem 0;
            color: var(--text-primary);
        }

        .warning-box {
            background: rgba(212, 165, 116, 0.15);
            border: 1px solid var(--accent-gold);
            border-radius: 4px;
            padding: 1rem;
            margin: 1rem 0;
            color: var(--text-primary);
        }

        /* Initial Prompt Box */
        .initial-prompt-box {
            background: linear-gradient(135deg, rgba(139, 107, 71, 0.1) 0%, rgba(160, 130, 109, 0.1) 100%);
            border: 1px solid var(--accent-bronze);
            border-radius: 6px;
            padding: 1.5rem;
            margin-bottom: 2rem;
        }

        .initial-prompt-label {
            font-weight: 700;
            color: var(--accent-bronze);
            margin-bottom: 0.5rem;
            font-family: 'Raleway', sans-serif;
            text-transform: uppercase;
            letter-spacing: 0.08em;
        }

        /* Persona icon */
        .persona-icon {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 40px;
            height: 40px;
            background: var(--accent-bronze);
            border-radius: 50%;
            margin-right: 1rem;
            font-size: 1.2rem;
            flex-shrink: 0;
            color: white;
            box-shadow: 0 2px 4px rgba(139, 107, 71, 0.2);
        }

        /* Thinking animation */
        .thinking-indicator::after {
            content: '...';
            display: inline-block;
            animation: thinking-dots 1.4s infinite;
            animation-timing-function: steps(4, end);
            width: 0px;
            overflow: hidden;
            vertical-align: bottom;
        }

        @keyframes thinking-dots {
            0% { width: 0; }
            33% { width: 0.6em; } /* . */
            66% { width: 1.2em; } /* .. */
            100% { width: 1.8em; } /* ... */
        }

        /* Modal styling */
        .modal-content {
            background: var(--card-bg) !important;
            border: 2px solid var(--border-color);
            border-radius: 8px;
        }

        .modal-header {
            border-bottom: 1px solid var(--border-color) !important;
            background: linear-gradient(135deg, rgba(212, 165, 116, 0.1) 0%, rgba(176, 141, 87, 0.1) 100%);
        }

        .modal-footer {
            border-top: 1px solid var(--border-color) !important;
        }

        .modal-backdrop {
            background-color: rgba(58, 35, 23, 0.6);
        }

        .modal-title {
            font-family: 'Raleway', sans-serif;
            color: var(--accent-bronze);
            font-weight: 600;
        }

        .btn-close {
            filter: none;
            opacity: 0.6;
        }

        .btn-close:hover {
            opacity: 1;
        }

        /* Button group styling */
        .conversation-controls {
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
        }

        @media (max-width: 768px) {
            .conversation-controls {
                margin-top: 0.5rem;
            }
            
            .conversation-controls button {
                flex: 1;
                min-width: 80px;
            }
        }

        /* Privacy Notice */
        .privacy-notice {
            background: linear-gradient(135deg, rgba(74, 93, 107, 0.1) 0%, rgba(107, 74, 93, 0.1) 100%);
            border: 1px solid var(--vintage-blue);
            border-radius: 6px;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            color: var(--text-primary);
            font-size: 1rem;
            line-height: 1.8;
            position: relative;
        }

        .privacy-notice::before {
            content: '⚑';
            position: absolute;
            top: 15px;
            left: 15px;
            font-size: 1.5rem;
            color: var(--vintage-blue);
            opacity: 0.3;
        }

        .privacy-notice i {
            color: var(--vintage-blue);
            margin-right: 0.5rem;
        }

        .auth-section {
            text-align: right;
            margin-bottom: 1rem;
            font-family: 'Raleway', sans-serif;
        }
    </style>
</head>
<body>
    <div class="container mt-5">
        <div class="auth-section">
            {% if current_user.is_authenticated %}
                <span class="me-3">Logged in as: <strong>{{ current_user.email }}</strong></span>
                <a href="{{ url_for('auth.logout') }}" class="btn btn-secondary btn-sm">Logout</a>
            {% else %}
                <a href="{{ url_for('auth.login') }}" class="btn btn-primary btn-sm">
                    <i class="fab fa-google"></i> Login with Google
                </a>
            {% endif %}
        </div>

        <!-- Creator Credit -->
        <div class="text-center mb-3">
            <small style="color: var(--text-secondary); font-family: 'Raleway', sans-serif; letter-spacing: 0.05em;">
                Created by Yoni Bar 
                <a href="https://www.linkedin.com/in/john-bar-42722921/" target="_blank" style="color: var(--accent-bronze); text-decoration: none;">
                    <i class="fab fa-linkedin"></i>
                </a>
            </small>
        </div>
        
        <div class="guide-link-banner">
            <a href="#guide-section">Explore this comprehensive guide with expert techniques!</a>
        </div>

        <h1>
            <i class="fas fa-robot"></i> AI Conversation Orchestrator
        </h1>
        <p class="subtitle">Design and execute multi-agent conversational flows with cutting-edge AI models</p>

        <div class="dev-note">
            <i class="fas fa-info-circle"></i>
            <div>
                <strong>Developer Mode Active</strong> - Console logging enabled
            </div>
        </div>

        <form id="main-form">
            <div class="glass-card">
                <h3 class="mb-4">
                    <i class="fas fa-comments"></i> Conversation Selection
                </h3>
                <div class="mb-3">
                    <label for="conversation_name" class="form-label">
                        <i class="fas fa-folder-open"></i> Active Conversation
                    </label>
                    <div class="row">
                        <div class="col-md-7 mb-2">
                            <select name="conversation_name" id="conversation_name" class="form-select model-select">
                                {% for name in conversation_names %}
                                <option value="{{ name }}" {% if name == selected_conversation %}selected{% endif %}>{{ name }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="col-md-5 mb-2">
                            <div class="conversation-controls">
                                <button type="button" class="btn btn-success btn-sm" id="create-conversation-btn" title="Create new conversation">
                                    <i class="fas fa-plus"></i> New
                                </button>
                                <button type="button" class="btn btn-primary btn-sm" id="edit-conversation-btn" title="Edit conversation name">
                                    <i class="fas fa-edit"></i> Edit
                                </button>
                                <button type="button" class="btn btn-danger btn-sm" id="delete-conversation-btn" title="Delete conversation">
                                    <i class="fas fa-trash"></i> Delete
                                </button>
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-7 mb-2">
                            <select name="conversation_name" id="conversation_name" class="form-select model-select">
                                {% for name in conversation_names %}
                                <option value="{{ name }}" {% if name == selected_conversation %}selected{% endif %}>{{ name }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="col-md-5 mb-2">
                            <div class="conversation-controls">
                                <button type="button" class="btn btn-success btn-sm" id="create-conversation-btn" title="Create new conversation">
                                    <i class="fas fa-plus"></i> New
                                </button>
                                <button type="button" class="btn btn-primary btn-sm" id="edit-conversation-btn" title="Edit conversation name">
                                    <i class="fas fa-edit"></i> Edit
                                </button>
                                <button type="button" class="btn btn-danger btn-sm" id="delete-conversation-btn" title="Delete conversation">
                                    <i class="fas fa-trash"></i> Delete
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div id="config-editor"></div>
            
            <div class="text-center mb-4">
                <button type="button" id="save-config-btn" class="btn btn-success">
                    <i class="fas fa-save"></i> Save Configuration
                </button>
            </div>
            <textarea name="config_json" id="config_json" style="display:none;"></textarea>

            <div class="section-divider"></div>

            <div class="glass-card">
                <h3 class="mb-4">
                    <i class="fas fa-play-circle"></i> Execute Conversation
                </h3>
                <div class="mb-4">
                    <label for="prompt" class="form-label">
                        <i class="fas fa-message"></i> Initial Prompt
                    </label>
                    <textarea name="prompt" id="prompt" rows="4" class="form-control" placeholder="Enter your prompt to start the conversation...">{{ prompt or '' }}</textarea>
                </div>
                <div class="text-center">
                    <button type="submit" class="btn btn-primary" id="run-conversation-btn">
                        <i class="fas fa-rocket"></i> Run Conversation
                    </button>
                    <button type="button" class="btn btn-warning" id="pause-conversation-btn" style="display: none;">
                        <i class="fas fa-pause"></i> Pause
                    </button>
                    <button type="button" class="btn btn-danger" id="stop-conversation-btn" style="display: none;">
                        <i class="fas fa-stop"></i> Stop Conversation
                    </button>
                </div>
            </div>
        </form>

        <div id="result-container" class="mt-4" style="display: none;">
            <div class="glass-card">
                <h3><i class="fas fa-check-circle" style="color: var(--success-green);"></i> Final Response</h3>
                <div id="final-response-box" class="response-box"></div>
            </div>
            
            <!-- Developer Credit Section -->
            <div id="developer-credit-section" class="developer-credit mt-4" style="display: none;">
                <div class="developer-credit-content">
                    <h6 class="developer-name">פותח על ידי יוני בר</h6>
                    <p class="developer-message">אני מקווה שהכלי הזה שימושי עבורכם!</p>
                    <p class="developer-feedback">יש לכם פידבק או רעיון לשיפור? אשמח לשמוע.</p>
                    <p class="developer-opportunity">בימים אלה אני בוחן הזדמנויות חדשות בהנדסת תוכנה.</p>
                    <a href="https://www.linkedin.com/in/john-bar-42722921/" target="_blank" class="linkedin-link">
                        <i class="fab fa-linkedin"></i> בואו נתחבר בלינקדאין
                    </a>
                </div>
            </div>
            
            <div class="glass-card mt-4">
                <h3><i class="fas fa-history"></i> Conversation History</h3>
                <div id="history-response-box" class="response-box"></div>
            </div>
        </div>

        <div class="guide-section" id="guide-section">
            <h2 class="text-center mb-4">
                <i class="fas fa-book"></i> Configuration Guide
            </h2>
            <p class="text-center text-secondary mb-4">Master the art of multi-agent conversation design</p>


            <h4><i class="fas fa-layer-group"></i> High-Level Overview</h4>
            <p>The configuration defines a set of conversational flows. Each flow, identified by a unique name, orchestrates a structured conversation between multiple AI "agents." These agents respond sequentially, each building upon the previous agent's response, to collaboratively address a user's prompt.</p>

            <h4><i class="fas fa-cogs"></i> Configuration Breakdown</h4>
            
            <h5><i class="fas fa-quote-left"></i> "opening_statement"</h5>
            <p><strong>Role:</strong> A global instruction or context-setter for the entire conversation.</p>
            <p><strong>Purpose:</strong> To provide shared context, ground rules, or a scenario that applies to all agents involved.</p>
            <p><em>Example: "You are a panel of experts debating the future of renewable energy."</em></p>

            <h5><i class="fas fa-users"></i> "agents": [ ... ]</h5>
            <p><strong>Role:</strong> A list containing the definitions for each agent that will participate in the conversation.</p>
            <p><strong>Purpose:</strong> To define the sequence of the conversation.</p>

            <h6><i class="fas fa-id-badge"></i> "agent_name"</h6>
            <p>The identity or persona of the AI agent (e.g., "Michael" or "Experienced Software Engineer").</p>

            <h6><i class="fas fa-brain"></i> "model"</h6>
            <p>Specifies which Large Language Model to use: "Gemini-2.5-pro", "Claude-Opus-4", "o3", or empty for default.</p>

            <h6><i class="fas fa-user-tag"></i> "Role"</h6>
            <p>A direct instruction defining the agent's primary role or goal.</p>

            <h4><i class="fas fa-code"></i> Examples</h4>
            
            <h5>Example 1: Customer Support Triaging</h5>
            <pre><code>{
  "customer_support_flow": {
    "opening_statement": "A customer has submitted a support ticket. Your goal is to resolve it efficiently.",
    "agents": [
      {
        "agent_name": "Tier 1 Support Bot",
        "Role": "Your job is to understand the user's issue and categorize it.",
        "model": "Gemini-2.5-pro"
      },
      {
        "agent_name": "Technical Specialist",
        "Role": "You are a technical expert. Provide solutions for technical issues.",
        "model": "Claude-Opus-4"
      }
    ]
  }
}</code></pre>

                         <h5>Example 2: Creative Writing Assistant</h5>
             <pre><code>{
   "story_generator": {
     "opening_statement": "Let's write a short story together.",
     "agents": [
       {
         "agent_name": "The Plotter",
         "Role": "Based on the user's prompt, outline a three-act plot.",
         "model": "o3"
       },
       {
         "agent_name": "The Narrator",
         "Role": "Take the plot outline and write the full story.",
         "model": "Claude-Opus-4"
       }
     ]
   }
 }</code></pre>

             <h4><i class="fas fa-star"></i> Pro-Tips for Effective Configuration</h4>
             <p>Leverage these strategies, derived from recent AI research, to elevate your agent configurations from good to great.</p>

             <h5><i class="fas fa-theater-masks"></i> 1. Design Complementary & Diverse Roles</h5>
             <p>Ensure each agent has a unique, well-defined purpose to prevent overlap and ensure comprehensive task coverage. Think of your agents like a specialized team.</p>
             <ul>
                 <li><strong>Specialize:</strong> Assign distinct roles like "Planner," "Executor," "Critic," and "Summarizer."</li>
                 <li><strong>Include a Contrarian:</strong> For critical tasks, add a "Devil's Advocate" agent. Its job is to challenge assumptions and find weaknesses. This drastically improves the robustness of the final output by preventing AI groupthink.</li>
             </ul>

             <h5><i class="fas fa-sitemap"></i> 2. Orchestrate the Conversation Flow</h5>
             <p>Don't leave the conversation to chance. A structured flow keeps agents on task and builds momentum.</p>
             <ul>
                 <li><strong>Define Turn-Taking:</strong> A simple, strict sequence (Agent 1 → Agent 2 → Agent 3) is highly effective. It prevents agents from talking over each other or getting stuck in loops.</li>
                 <li><strong>Use Phased Approaches:</strong> For complex projects, break the task into phases (e.g., Design, Code, Test) and have agents collaborate in a structured "chat chain" within each phase.</li>
             </ul>

             <h5><i class="fas fa-magic"></i> 3. Master Your Prompting Technique</h5>
             <p>The quality of your prompts directly determines the quality of the output.</p>
             <ul>
                 <li><strong>Use the Second-Person Imperative:</strong> Always frame instructions as a direct command: <code>You are a...</code> or <code>Your task is to...</code>. This is more effective than the first-person (<code>I am a...</code>).</li>
                 <li><strong>Give Names and Personas:</strong> Assigning human-like names (e.g., "Alice the Analyst") makes the AI's behavior more consistent and the dialogue easier to follow. The model is better at maintaining a distinct persona for a named character.</li>
                 <li><strong>Add Rich Personal Details:</strong> Include hobbies, background, and personal characteristics in your agent descriptions (e.g., "Michael, a 40-year-old doctor who loves gardening and classical music"). Research shows this creates more believable, consistent agent behavior and improves multi-agent interactions significantly.</li>
                 <li><strong>Be Specific & Contextual:</strong> The <code>Role</code> should be a crystal-clear instruction. Use the <code>opening_statement</code> to provide universal context that all agents need, keeping them aligned.</li>
             </ul>
             
             <h5><i class="fas fa-vial"></i> 4. Iterate and Refine</h5>
             <p>The perfect configuration is rarely achieved on the first try. Treat it as a science experiment.</p>
             <ul>
                 <li><strong>Start Small:</strong> Begin with a simple two-agent flow to test your core idea.</li>
                 <li><strong>Analyze the Transcript:</strong> After a run, read the conversation history. Where did it go wrong? Which agent got confused? What was misunderstood?</li>
                 <li><strong>Tweak and Re-run:</strong> Adjust the prompts, agent order, or roles based on your observations and try again. The best results come from iterative improvement.</li>
             </ul>
         </div>
</div>

<script id="config-data" type="application/json">
    {{- config | tojson | safe -}}
</script>

<script>
    console.log("Initializing script...");
    let configData = {};
    let currentConversationName;
    let currentAbortController = null;
    let currentConversationId = null;
    let isPaused = false;
    // Track if any error occurred during the conversation run
    let errorsOccurred = false;
    
    try {
        const configJsonString = document.getElementById('config-data').textContent.trim();
        console.log("Raw config string from <script> tag:", configJsonString);
        if (configJsonString) {
            configData = JSON.parse(configJsonString);
            console.log("Configuration data loaded and parsed successfully:", JSON.parse(JSON.stringify(configData)));
        } else {
            console.log("Configuration data script tag is empty, initializing with empty object.");
            configData = {};
        }
    } catch (e) {
        console.error("FATAL: Failed to parse configuration data from server.", e);
        alert("A critical error occurred while loading the page configuration. Please check the console for details.");
        configData = {}; // Fallback
    }

    document.addEventListener('DOMContentLoaded', () => {
        console.log("DOM fully loaded and parsed.");
        const convSelect = document.getElementById('conversation_name');
        currentConversationName = convSelect.value;
        console.log(`Initial conversation selected in dropdown: '${currentConversationName}'`);

        if (currentConversationName) {
            console.log("Calling renderEditor for the initial conversation.");
            renderEditor(currentConversationName);
        } else {
            console.warn("No conversation was selected on page load.");
            document.getElementById('config-editor').innerHTML = '<div class="glass-card"><p class="text-secondary text-center">No configuration loaded. Select a conversation to begin or create a new one.</p></div>';
        }

        const saveBtn = document.getElementById('save-config-btn');
        if (saveBtn) {
            saveBtn.addEventListener('click', saveConfiguration);
        }

        // Add event listener for create conversation button
        const createConvBtn = document.getElementById('create-conversation-btn');
        if (createConvBtn) {
            createConvBtn.addEventListener('click', showCreateConversationModal);
        }

        // Add event listener for edit conversation button
        const editConvBtn = document.getElementById('edit-conversation-btn');
        if (editConvBtn) {
            editConvBtn.addEventListener('click', showEditConversationModal);
        }

        // Add event listener for delete conversation button
        const deleteConvBtn = document.getElementById('delete-conversation-btn');
        if (deleteConvBtn) {
            deleteConvBtn.addEventListener('click', showDeleteConversationModal);
        }

        // Add event listener for confirm create button in modal
        const confirmCreateBtn = document.getElementById('confirm-create-conversation');
        if (confirmCreateBtn) {
            confirmCreateBtn.addEventListener('click', createNewConversation);
        }

        // Add event listener for confirm edit button in modal
        const confirmEditBtn = document.getElementById('confirm-edit-conversation');
        if (confirmEditBtn) {
            confirmEditBtn.addEventListener('click', editConversation);
        }

        // Add event listener for confirm delete button in modal
        const confirmDeleteBtn = document.getElementById('confirm-delete-conversation');
        if (confirmDeleteBtn) {
            confirmDeleteBtn.addEventListener('click', deleteConversation);
        }

        // Add enter key support for conversation name input
        const newConvNameInput = document.getElementById('new-conversation-name');
        if (newConvNameInput) {
            newConvNameInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    createNewConversation();
                }
            });
        }

        // Add enter key support for edit conversation name input
        const editConvNameInput = document.getElementById('edit-conversation-name');
        if (editConvNameInput) {
            editConvNameInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    editConversation();
                }
            });
        }

        // Add event listener for create conversation button
        const createConvBtn = document.getElementById('create-conversation-btn');
        if (createConvBtn) {
            createConvBtn.addEventListener('click', showCreateConversationModal);
        }

        // Add event listener for edit conversation button
        const editConvBtn = document.getElementById('edit-conversation-btn');
        if (editConvBtn) {
            editConvBtn.addEventListener('click', showEditConversationModal);
        }

        // Add event listener for delete conversation button
        const deleteConvBtn = document.getElementById('delete-conversation-btn');
        if (deleteConvBtn) {
            deleteConvBtn.addEventListener('click', showDeleteConversationModal);
        }

        // Add event listener for confirm create button in modal
        const confirmCreateBtn = document.getElementById('confirm-create-conversation');
        if (confirmCreateBtn) {
            confirmCreateBtn.addEventListener('click', createNewConversation);
        }

        // Add event listener for confirm edit button in modal
        const confirmEditBtn = document.getElementById('confirm-edit-conversation');
        if (confirmEditBtn) {
            confirmEditBtn.addEventListener('click', editConversation);
        }

        // Add event listener for confirm delete button in modal
        const confirmDeleteBtn = document.getElementById('confirm-delete-conversation');
        if (confirmDeleteBtn) {
            confirmDeleteBtn.addEventListener('click', deleteConversation);
        }

        // Add enter key support for conversation name input
        const newConvNameInput = document.getElementById('new-conversation-name');
        if (newConvNameInput) {
            newConvNameInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    createNewConversation();
                }
            });
        }

        // Add enter key support for edit conversation name input
        const editConvNameInput = document.getElementById('edit-conversation-name');
        if (editConvNameInput) {
            editConvNameInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    editConversation();
                }
            });
        }
    });

    function renderEditor(convName) {
        console.log(`%c--- Rendering editor for: ${convName} ---`, 'color: blue; font-weight: bold;');
        const editor = document.getElementById('config-editor');
        if (!convName || !configData[convName]) {
            console.error(`renderEditor failed: No data found for conversation name '${convName}'.`);
            editor.innerHTML = '<div class="glass-card"><p class="text-danger text-center"><i class="fas fa-exclamation-triangle"></i> Error: Could not find configuration for the selected conversation.</p></div>';
            return;
        }
        
        // Update the conversation name input if it exists
        const convNameInput = document.getElementById('conversation-name-input');
        if (convNameInput) {
            convNameInput.value = convName;
        }
        
        // Update the conversation name input if it exists
        const convNameInput = document.getElementById('conversation-name-input');
        if (convNameInput) {
            convNameInput.value = convName;
        }

        const conversation = configData[convName];
        console.log("Conversation object being rendered:", JSON.parse(JSON.stringify(conversation)));

        let agentsHtml = (conversation.agents || []).map((agent, index) => {
            console.log(`Building HTML for Agent ${index + 1}`, agent);
            return `
            <div class="agent-card" data-agent-index="${index}">
                <div class="agent-card-header">
                    <h5 class="mb-0">
                        <span class="agent-number">${index + 1}</span>
                        ${agent.agent_name || 'Unnamed Agent'}
                    </h5>
                    <button type="button" class="btn btn-sm btn-danger remove-agent-btn">
                        <i class="fas fa-trash"></i> Remove
                    </button>
                </div>
                <div class="agent-card-body">
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label" title="The identity or persona of the AI agent">
                                <i class="fas fa-id-badge"></i> Agent Name
                            </label>
                            <input type="text" class="form-control" value="${agent.agent_name || ''}" data-config-key="agent_name">
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label" title="The language model to use for this agent">
                                <i class="fas fa-brain"></i> Model
                            </label>
                            <select class="form-select model-select" data-config-key="model">
                                <option value="" ${!agent.model ? 'selected' : ''}>Default (Gemini)</option>
                                <option value="Gemini-2.5-pro" ${agent.model === 'Gemini-2.5-pro' ? 'selected' : ''}>Gemini-2.5-pro</option>
                                <option value="Claude-Opus-4" ${agent.model === 'Claude-Opus-4' ? 'selected' : ''}>Claude-Opus-4</option>
                                <option value="o3" ${agent.model === 'o3' ? 'selected' : ''}>o3</option>
                            </select>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label class="form-label" title="A direct instruction defining the agent's primary role">
                            <i class="fas fa-user-tag"></i> Role
                        </label>
                        <textarea class="form-control" rows="2" data-config-key="Role">${agent.Role || ''}</textarea>
                    </div>
                </div>
            </div>
        `}).join('');
        console.log("Generated HTML for all agents.");

        const editorHtml = `
            <div class="glass-card">
                <h3 class="mb-4">
                    <i class="fas fa-sliders-h"></i> Conversation Configuration
                </h3>
                <div class="row">
                    <div class="col-md-12 mb-3">
                        <label class="form-label" title="The unique name for this conversational flow">
                            <i class="fas fa-tag"></i> Conversation Name
                        </label>
                        <input type="text" class="form-control" id="conversation-name-input" value="${convName}">
                    </div>
                </div>
                <div class="mb-3">
                    <label class="form-label" title="A global instruction or context-setter for the entire conversation">
                        <i class="fas fa-quote-left"></i> Opening Statement
                    </label>
                    <textarea class="form-control" id="opening-statement-input" rows="3">${conversation.opening_statement || ''}</textarea>
                </div>
            </div>

            <div class="glass-card">
                <h3 class="mb-4">
                    <i class="fas fa-users"></i> Agent Configuration
                </h3>
                <div id="agents-container">${agentsHtml}</div>
                <div class="text-center">
                    <button type="button" class="btn btn-outline-success" id="add-agent-btn">
                        <i class="fas fa-plus-circle"></i> Add Agent
                    </button>
                </div>
            </div>
        `;

        editor.innerHTML = editorHtml;
        console.log("Editor HTML has been set. Attaching event listeners now.");
        attachEditorEventListeners();
    }
    
    function updateConfigDataFromEditor() {
        console.log(`Updating configData in memory from editor for: ${currentConversationName}`);
        if (!currentConversationName || !configData[currentConversationName]) {
            console.warn("Cannot update config from editor: no valid conversation selected.");
            return;
        }

        const conversation = configData[currentConversationName];

        const openingStatementInput = document.getElementById('opening-statement-input');
        if (openingStatementInput) {
            conversation.opening_statement = openingStatementInput.value;
        }
        
        const updatedAgents = [];
        document.querySelectorAll('#agents-container .agent-card[data-agent-index]').forEach(agentCard => {
            const agent = {};
            agentCard.querySelectorAll('[data-config-key]').forEach(input => {
                agent[input.dataset.configKey] = input.value;
            });
            updatedAgents.push(agent);
        });
        conversation.agents = updatedAgents;

        console.log("configData updated from editor state:", JSON.parse(JSON.stringify(configData[currentConversationName])));
    }

    function attachEditorEventListeners() {
        console.log("Attaching editor event listeners...");
        const addAgentBtn = document.getElementById('add-agent-btn');
        if (addAgentBtn) {
            addAgentBtn.addEventListener('click', () => {
                console.log(`'Add Agent' button clicked for conversation: '${currentConversationName}'`);
                
                // First, update the config data from the current state of the editor UI
                updateConfigDataFromEditor();

                if (!configData[currentConversationName].agents) {
                    console.log("Agent array did not exist, creating it.");
                    configData[currentConversationName].agents = [];
                }
                const newAgent = {
                    agent_name: "New Agent",
                    Role: "",
                    model: ""
                };
                configData[currentConversationName].agents.push(newAgent);
                console.log("New agent added to config data. Rerendering editor.", configData[currentConversationName]);
                renderEditor(currentConversationName);
            });
        } else {
            console.error("Could not find 'Add Agent' button to attach listener.");
        }

        document.querySelectorAll('.remove-agent-btn').forEach(button => {
            button.addEventListener('click', (e) => {
                const agentCard = e.target.closest('.agent-card[data-agent-index]');
                const index = parseInt(agentCard.dataset.agentIndex, 10);
                console.log(`'Remove Agent' button clicked for agent at index: ${index}`);

                // First, update the config data from the current state of the editor UI
                updateConfigDataFromEditor();
                
                if (configData[currentConversationName] && configData[currentConversationName].agents) {
                    configData[currentConversationName].agents.splice(index, 1);
                    console.log(`Agent at index ${index} removed. Rerendering editor.`);
                    renderEditor(currentConversationName);
                } else {
                    console.error("Could not remove agent - config structure is unexpected.");
                }
            });
        });
        console.log("Finished attaching listeners for add/remove buttons.");
    }

    function saveConfiguration() {
        console.log("%c--- Saving configuration ---", "color: #28a745; font-weight: bold;");
        const finalConfig = updateAndGetFinalConfig();
        
        const saveBtn = document.getElementById('save-config-btn');
        const originalText = saveBtn.textContent;
        saveBtn.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Saving...';
        saveBtn.disabled = true;

        fetch('/save_config', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(finalConfig, null, 2),
        })
        .then(response => {
            if (!response.ok) {
                return response.json().then(err => { throw new Error(err.message || 'An unknown error occurred.') });
            }
            return response.json();
        })
        .then(data => {
            console.log('Save response:', data);
            saveBtn.textContent = 'Saved!';
            setTimeout(() => {
                saveBtn.textContent = originalText;
                saveBtn.disabled = false;
            }, 2000);
        })
        .catch((error) => {
            console.error('Error:', error);
            alert('An error occurred while saving: ' + error.message);
            saveBtn.textContent = originalText;
            saveBtn.disabled = false;
        });
    }

    function updateAndGetFinalConfig() {
        console.log("%c--- Updating and finalizing config for submission ---", "color: green; font-weight: bold;");
        
        const nameInput = document.getElementById('conversation-name-input');
        const newConvName = nameInput ? nameInput.value : currentConversationName;
        console.log(`Current conversation name in editor is: '${newConvName}'`);

        const newConversationData = {
            opening_statement: document.getElementById('opening-statement-input').value,
            agents: []
        };
        console.log("Built base conversation data from opening/closing statements:", newConversationData);

        document.querySelectorAll('#agents-container .agent-card[data-agent-index]').forEach((agentCard, index) => {
            console.log(`Processing data for agent card at index ${index}`);
            const agent = {};
            agentCard.querySelectorAll('[data-config-key]').forEach(input => {
                const key = input.dataset.configKey;
                agent[key] = input.value;
            });
            newConversationData.agents.push(agent);
            console.log(`Agent ${index} data collected:`, agent);
        });

        if (newConvName !== currentConversationName) {
            console.warn(`Conversation name changed from '${currentConversationName}' to '${newConvName}'. The old entry will be deleted.`);
            const oldName = currentConversationName;
            // Create new entry before deleting old one
            configData[newConvName] = newConversationData;
            delete configData[oldName];
            currentConversationName = newConvName;
             // Update dropdown to reflect name change
            updateDropdown();
        } else {
            console.log(`Updating data for existing conversation: '${currentConversationName}'`);
            configData[currentConversationName] = newConversationData;
        }

        console.log("Final config object after update:", JSON.parse(JSON.stringify(configData)));
        return configData;
    }
    
    function updateDropdown() {
        console.log("Updating dropdown with latest conversation names.");
        const select = document.getElementById('conversation_name');
        const newListOfNames = Object.keys(configData);
        
        console.log("New list of names:", newListOfNames);
        console.log(`Previously selected name was: '${currentConversationName}'`);
        
        // Re-create options, preserving selection if possible
        select.innerHTML = '';
        if (newListOfNames.length === 0) {
            // Handle empty case
            const option = document.createElement('option');
            option.value = '';
            option.textContent = 'No conversations available';
            select.appendChild(option);
            select.disabled = true;
        } else {
            select.disabled = false;
            newListOfNames.forEach(name => {
                const option = document.createElement('option');
                option.value = name;
                option.textContent = name;
                select.appendChild(option);
            });
            select.value = currentConversationName;
        }
        if (newListOfNames.length === 0) {
            // Handle empty case
            const option = document.createElement('option');
            option.value = '';
            option.textContent = 'No conversations available';
            select.appendChild(option);
            select.disabled = true;
        } else {
            select.disabled = false;
            newListOfNames.forEach(name => {
                const option = document.createElement('option');
                option.value = name;
                option.textContent = name;
                select.appendChild(option);
            });
            select.value = currentConversationName;
        }
        console.log(`Dropdown updated. Current value is set to: '${select.value}'`);
    }

    function resetRunButton() {
        const runBtn = document.getElementById('run-conversation-btn');
        const stopBtn = document.getElementById('stop-conversation-btn');
        const pauseBtn = document.getElementById('pause-conversation-btn');
        runBtn.disabled = false;
        runBtn.innerHTML = '<i class="fas fa-rocket"></i> Run Conversation';
        stopBtn.style.display = 'none';
        pauseBtn.style.display = 'none';
        currentAbortController = null;
        currentConversationId = null;
        isPaused = false;
    }

    function showDeveloperCreditIfFinalResponse() {
        const finalResponseBox = document.getElementById('final-response-box');
        const developerCreditSection = document.getElementById('developer-credit-section');
        
        if (!finalResponseBox || !developerCreditSection) return;

        const responseText = (finalResponseBox.textContent || finalResponseBox.innerText || '').trim();

        // Conditions for success: non-empty, not the placeholder, and not an error message
        const isLikelyError = /^(error|fatal|warning|stopped)/i.test(responseText);
        const hasContent = responseText && responseText !== 'Thinking...';

        if (hasContent && !isLikelyError && !errorsOccurred) {
            developerCreditSection.style.display = 'block';
        }
    }

    function hideDeveloperCredit() {
        const developerCreditSection = document.getElementById('developer-credit-section');
        if (developerCreditSection) {
            developerCreditSection.style.display = 'none';
        }
    }

    // Add event listener for pause button
    document.getElementById('pause-conversation-btn').addEventListener('click', () => {
        if (!currentConversationId) {
            console.error("Cannot pause/resume, no conversation ID.");
            return;
        }
        
        const pauseBtn = document.getElementById('pause-conversation-btn');
        const url = isPaused ? `/resume_conversation/${currentConversationId}` : `/pause_conversation/${currentConversationId}`;

        fetch(url, { method: 'POST' })
            .then(response => {
                if (!response.ok) {
                    throw new Error('Network response was not ok');
                }
                return response.json();
            })
            .then(data => {
                if (data.status === 'success') {
                    if (isPaused) {
                        // We just resumed
                        isPaused = false;
                        pauseBtn.innerHTML = '<i class="fas fa-pause"></i> Pause';
                        pauseBtn.classList.remove('btn-success');
                        pauseBtn.classList.add('btn-warning');
                    } else {
                        // We just paused
                        isPaused = true;
                        pauseBtn.innerHTML = '<i class="fas fa-play"></i> Resume';
                        pauseBtn.classList.remove('btn-warning');
                        pauseBtn.classList.add('btn-success');
                    }
                } else {
                    console.error("Failed to toggle pause state:", data.message);
                    alert("Error: " + data.message);
                }
            }).catch(err => {
                console.error("Error calling pause/resume endpoint:", err);
                alert("An error occurred trying to pause/resume.");
            });
    });

    document.getElementById('main-form').addEventListener('submit', (e) => {
        e.preventDefault();
        console.log("%c--- Form submission triggered for streaming ---", "color: orange; font-weight: bold;");

        const runBtn = document.getElementById('run-conversation-btn');
        const stopBtn = document.getElementById('stop-conversation-btn');
        const pauseBtn = document.getElementById('pause-conversation-btn');
        runBtn.disabled = true;
        runBtn.innerHTML = `
            <span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>
            Running...
        `;
        stopBtn.style.display = 'inline-block';
        pauseBtn.style.display = 'inline-block';

        // Show and clear result containers
        const resultContainer = document.getElementById('result-container');
        const finalResponseBox = document.getElementById('final-response-box');
        const historyResponseBox = document.getElementById('history-response-box');
        resultContainer.style.display = 'block';
        finalResponseBox.innerHTML = '';
        historyResponseBox.innerHTML = '<div class="formatted-response">Initializing conversation...</div>';
        
        // Hide developer credit at start of conversation
        hideDeveloperCredit();
        // Reset error flag at the beginning of a new run
        errorsOccurred = false;

        const finalConfig = updateAndGetFinalConfig();
        const prompt = document.getElementById('prompt').value;

        const payload = {
            prompt: prompt,
            conversation_name: currentConversationName,
            config: finalConfig,
            api_keys: {}  // API keys are now handled server-side
        };
        console.log("Payload for streaming:", payload);

        // Create new AbortController for this request
        currentAbortController = new AbortController();

        fetch('/stream_conversation', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(payload),
            signal: currentAbortController.signal
        }).then(response => {
            const reader = response.body.getReader();
            const decoder = new TextDecoder();

            function read() {
                reader.read().then(({ done, value }) => {
                    if (done) {
                        console.log("Stream complete");
                        resetRunButton();
                        return;
                    }
                    
                    const chunk = decoder.decode(value, { stream: true });
                    const events = chunk.split('\n\n');
                    
                    for (const eventStr of events) {
                        if (eventStr.trim() === '') continue;
                        if (!eventStr.startsWith('data:')) continue;

                        const jsonStr = eventStr.substring(5);
                        try {
                            const data = JSON.parse(jsonStr);
                            if (data.type === 'system' && data.conversation_id) {
                                currentConversationId = data.conversation_id;
                                console.log(`Received conversation ID: ${currentConversationId}`);
                            } else if (data.type === 'history_update') {
                                // Format the conversation history
                                historyResponseBox.innerHTML = formatConversationText(data.history);
                                // Format the final response
                                finalResponseBox.innerHTML = formatContent(data.final_response);
                                // Show developer credit if final response has content
                                showDeveloperCreditIfFinalResponse();
                            } else if (data.type === 'final_response_update') {
                                finalResponseBox.innerHTML = formatContent(data.final_response);
                                // Show developer credit if final response has content
                                showDeveloperCreditIfFinalResponse();
                            } else if (data.type === 'error') {
                                console.error("SSE Error:", data.message);
                                historyResponseBox.innerHTML += `<div class="warning-box"><strong>ERROR:</strong> ${escapeHtml(data.message)}</div>`;
                                // Mark that an error has occurred and hide developer credit
                                errorsOccurred = true;
                                hideDeveloperCredit();
                                resetRunButton();
                            } else if (data.type === 'done') {
                                console.log("SSE stream finished.");
                                resetRunButton();
                            } else if (data.type === 'heartbeat') {
                                console.log("Received pause heartbeat from server...");
                            }
                        } catch (e) {
                            console.error("Error parsing SSE event:", e, "Raw event:", eventStr);
                        }
                    }

                    read();
                }).catch(error => {
                    if (error.name === 'AbortError') {
                        console.log("Stream aborted by user");
                        historyResponseBox.innerHTML += '<div class="warning-box"><strong>STOPPED:</strong> Conversation stopped by user.</div>';
                    } else {
                        console.error("Stream read error:", error);
                        historyResponseBox.innerHTML += '<div class="warning-box"><strong>ERROR:</strong> Failed to read stream.</div>';
                    }
                    resetRunButton();
                });
            }
            read();
        }).catch(err => {
            if (err.name === 'AbortError') {
                console.log("Fetch aborted by user");
                historyResponseBox.innerHTML += '<div class="warning-box"><strong>STOPPED:</strong> Conversation stopped by user.</div>';
            } else {
                console.error("Fetch stream failed:", err);
                historyResponseBox.innerHTML += '<div class="warning-box"><strong>FATAL ERROR:</strong> Could not connect to the server.</div>';
            }
            resetRunButton();
        });
    });

    document.getElementById('conversation_name').addEventListener('change', (e) => {
        const oldName = currentConversationName;
        currentConversationName = e.target.value;
        console.log(`%c--- Switched selected conversation from '${oldName}' to '${currentConversationName}' ---`, "color: purple; font-weight: bold;");
        renderEditor(currentConversationName);
    });

    // Add event listener for stop button
    document.getElementById('stop-conversation-btn').addEventListener('click', () => {
        console.log("Stop button clicked, aborting conversation...");
        if (currentAbortController) {
            currentAbortController.abort();
        }
    });

    // Conversation formatting functions
    function formatConversationText(text) {
        console.log("Formatting conversation text...");
        
        // Handle empty text
        if (!text) return '<div class="formatted-response">No content to display.</div>';
        
        const formatted = document.createElement('div');
        formatted.className = 'formatted-response';
        
        // Split by agent separators (look for variations)
        const agentSeparators = /\n-{10,}\n|\n={10,}\n|\n\*{3,}\n/g;
        const sections = text.split(agentSeparators);
        
        sections.forEach((section, index) => {
            if (section.trim()) {
                const agentCard = formatAgentSection(section, index);
                if (agentCard) {
                    formatted.appendChild(agentCard);
                }
            }
        });
        
        return formatted.outerHTML;
    }

    function formatAgentSection(text, index) {
        const block = document.createElement('div');
        block.className = 'agent-response-block';
        
        // Try to parse agent header
        const lines = text.trim().split('\n');
        let agentName = '';
        let agentDescription = '';
        let contentStart = 0;
        
        const firstLine = lines[0];
        
        // Handle initial user prompt block separately
        if (firstLine.startsWith('USER PROMPT:')) {
            block.innerHTML = formatContent(text);
            return block;
        }

        // Look for "Name - Description" pattern, which is how we format it in Python
        const agentPattern = /^(.+?)(?:\s+-\s+(.+))?$/;
        let match = firstLine.match(agentPattern);

        if (match) {
            agentName = match[1].trim();
            agentDescription = (match[2] || '').trim();
            contentStart = 1;
        } else {
            // Fallback for unexpected formats
            agentName = firstLine;
            contentStart = 1;
        }
        
        // Remove suffix line if present
        if (lines[lines.length - 1].startsWith("This was") && lines[lines.length - 1].endsWith("'s response")) {
            lines.pop();
        }

        // Create header
        const header = document.createElement('div');
        header.className = 'agent-response-header';
        header.innerHTML = `
            <i class="fas fa-user-circle persona-icon"></i>
            <div class="agent-header-text">
                <div class="agent-response-name">${escapeHtml(agentName)}</div>
                ${agentDescription ? `<div class="agent-response-description">${escapeHtml(agentDescription)}</div>` : ''}
            </div>
        `;
        block.appendChild(header);
        
        // Create body
        const body = document.createElement('div');
        body.className = 'agent-response-body';
        
        // Process content
        const content = lines.slice(contentStart).join('\n');
        body.innerHTML = formatContent(content);
        
        block.appendChild(body);
        
        return block;
    }

    function formatContent(text) {
        // Special handling for the "Thinking..." message to add an animation
        if (text.trim() === 'Thinking...') {
            return `<span class="thinking-indicator">Thinking</span>`;
        }

        let formatted = text;
        
        // Escape HTML first
        formatted = escapeHtml(formatted);
        
        // Format code blocks (```...```)
        formatted = formatted.replace(/```(\w+)?\n([\s\S]*?)```/g, function(match, lang, code) {
            return `<div class="formatted-code-block"><code>${code.trim()}</code></div>`;
        });
        
        // Format dialogue lines (**Speaker:** "Quote")
        formatted = formatted.replace(/\*\*([^:]+):\*\*\s*[""]([^""]+)[""]/g, function(match, speaker, text) {
            return `<div class="dialogue-line">
                <div class="dialogue-speaker">${speaker}:</div>
                <div class="dialogue-text">${text}</div>
            </div>`;
        });
        
        // Format bold text
        formatted = formatted.replace(/\*\*([^*]+)\*\*/g, '<strong>$1</strong>');
        
        // Format inline code (backticks)
        formatted = formatted.replace(/`([^`]+)`/g, '<code>$1</code>');
        
        // Format numbered lists
        formatted = formatted.replace(/^(\d+)\.\s+(.+)$/gm, function(match, num, text) {
            return `<li value="${num}">${text}</li>`;
        });
        
        // Wrap consecutive li elements in ol
        formatted = formatted.replace(/(<li[^>]*>[\s\S]*?<\/li>\s*)+/g, function(match) {
            return `<ol>${match}</ol>`;
        });
        
        // Format section separators (*** or ---)
        formatted = formatted.replace(/^[\*\-]{3,}$/gm, '<div class="conversation-separator"></div>');
        
        // Format file paths and commands
        formatted = formatted.replace(/["']([A-Za-z]:\\[^"']+)['"]/g, '<code>$1</code>');
        
        // Format USER PROMPT
        formatted = formatted.replace(/^USER PROMPT:\s*(.+)$/m, function(match, prompt) {
            return `<div class="initial-prompt-box">
                <div class="initial-prompt-label">USER PROMPT:</div>
                <div>${prompt}</div>
            </div>`;
        });
        
        // Format warnings (look for keywords like "warning", "caution", "note")
        formatted = formatted.replace(/^(Warning|Caution|Note):\s*(.+)$/gmi, function(match, type, text) {
            const boxClass = type.toLowerCase() === 'warning' || type.toLowerCase() === 'caution' ? 'warning-box' : 'info-box';
            return `<div class="${boxClass}"><strong>${type}:</strong> ${text}</div>`;
        });
        
        // Convert newlines to <br> for better formatting
        formatted = formatted.replace(/\n/g, '<br>');
        
        return formatted;
    }

    function escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }

    function showCreateConversationModal() {
        console.log("Showing create conversation modal");
        const modal = new bootstrap.Modal(document.getElementById('newConversationModal'));
        const nameInput = document.getElementById('new-conversation-name');
        nameInput.value = ''; // Clear any previous value
        modal.show();
        // Focus on the input after modal is shown
        setTimeout(() => nameInput.focus(), 300);
    }

    function createNewConversation() {
        console.log("Creating new conversation");
        const nameInput = document.getElementById('new-conversation-name');
        const newName = nameInput.value.trim();
        
        // Validate name
        if (!newName) {
            alert('Please enter a conversation name.');
            nameInput.focus();
            return;
        }
        
        // Check if name already exists
        if (configData.hasOwnProperty(newName)) {
            alert(`A conversation named "${newName}" already exists. Please choose a different name.`);
            nameInput.focus();
            return;
        }
        
        // Create new conversation with default structure
        const newConversation = {
            opening_statement: "",
            agents: [
                {
                    agent_name: "Agent 1",
                    model: "",
                    Role: ""
                }
            ]
        };
        
        console.log(`Creating new conversation: ${newName}`, newConversation);
        
        // Add to config data
        configData[newName] = newConversation;
        currentConversationName = newName;
        
        // Update dropdown
        updateDropdown();
        
        // Close modal
        const modal = bootstrap.Modal.getInstance(document.getElementById('newConversationModal'));
        modal.hide();
        
        // Render the new conversation in the editor
        renderEditor(newName);
        
        // Automatically save the new conversation
        console.log("Auto-saving new conversation to server...");
        fetch('/save_config', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(configData, null, 2),
        })
        .then(response => {
            if (!response.ok) {
                return response.json().then(err => { throw new Error(err.message || 'An unknown error occurred.') });
            }
            return response.json();
        })
        .then(data => {
            console.log('New conversation saved successfully:', data);
            // Show a success message
            const createBtn = document.getElementById('create-conversation-btn');
            const originalText = createBtn.innerHTML;
            createBtn.innerHTML = '<i class="fas fa-check"></i> Created & Saved!';
            createBtn.classList.add('btn-success');
            setTimeout(() => {
                createBtn.innerHTML = originalText;
            }, 2000);
        })
        .catch((error) => {
            console.error('Error saving new conversation:', error);
            alert('The conversation was created but could not be saved automatically. Please click "Save Configuration" to save it manually. Error: ' + error.message);
        });
    }

    function showEditConversationModal() {
        console.log("Showing edit conversation modal");
        if (!currentConversationName) {
            alert('No conversation selected to edit.');
            return;
        }
        
        const modal = new bootstrap.Modal(document.getElementById('editConversationModal'));
        const nameInput = document.getElementById('edit-conversation-name');
        const currentNameSpan = document.getElementById('current-conversation-name');
        
        currentNameSpan.textContent = currentConversationName;
        nameInput.value = currentConversationName;
        modal.show();
        
        // Focus and select all text in the input after modal is shown
        setTimeout(() => {
            nameInput.focus();
            nameInput.select();
        }, 300);
    }

    function editConversation() {
        console.log("Editing conversation name");
        const nameInput = document.getElementById('edit-conversation-name');
        const newName = nameInput.value.trim();
        const oldName = currentConversationName;
        
        // Validate name
        if (!newName) {
            alert('Please enter a conversation name.');
            nameInput.focus();
            return;
        }
        
        // Check if name is the same
        if (newName === oldName) {
            console.log("Name unchanged, closing modal");
            const modal = bootstrap.Modal.getInstance(document.getElementById('editConversationModal'));
            modal.hide();
            return;
        }
        
        // Check if new name already exists
        if (configData.hasOwnProperty(newName)) {
            alert(`A conversation named "${newName}" already exists. Please choose a different name.`);
            nameInput.focus();
            return;
        }
        
        console.log(`Renaming conversation from "${oldName}" to "${newName}"`);
        
        // Copy the conversation data to new name and delete old
        configData[newName] = configData[oldName];
        delete configData[oldName];
        currentConversationName = newName;
        
        // Update dropdown
        updateDropdown();
        
        // Close modal
        const modal = bootstrap.Modal.getInstance(document.getElementById('editConversationModal'));
        modal.hide();
        
        // Render the conversation with new name
        renderEditor(newName);
        
        // Auto-save the changes
        console.log("Auto-saving renamed conversation...");
        fetch('/save_config', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(configData, null, 2),
        })
        .then(response => {
            if (!response.ok) {
                return response.json().then(err => { throw new Error(err.message || 'An unknown error occurred.') });
            }
            return response.json();
        })
        .then(data => {
            console.log('Conversation renamed and saved successfully:', data);
            // Show success message
            const editBtn = document.getElementById('edit-conversation-btn');
            const originalText = editBtn.innerHTML;
            editBtn.innerHTML = '<i class="fas fa-check"></i> Renamed!';
            setTimeout(() => {
                editBtn.innerHTML = originalText;
            }, 2000);
        })
        .catch((error) => {
            console.error('Error saving renamed conversation:', error);
            alert('The conversation was renamed but could not be saved automatically. Please click "Save Configuration" to save it manually. Error: ' + error.message);
        });
    }

    function showDeleteConversationModal() {
        console.log("Showing delete conversation modal");
        if (!currentConversationName) {
            alert('No conversation selected to delete.');
            return;
        }
        
        // Check if this is the last conversation
        const conversationCount = Object.keys(configData).length;
        if (conversationCount <= 1) {
            alert('Cannot delete the last conversation. Create a new one first.');
            return;
        }
        
        const modal = new bootstrap.Modal(document.getElementById('deleteConversationModal'));
        const nameSpan = document.getElementById('delete-conversation-name');
        
        nameSpan.textContent = currentConversationName;
        modal.show();
    }

    function deleteConversation() {
        console.log(`Deleting conversation: ${currentConversationName}`);
        const nameToDelete = currentConversationName;
        
        // Delete the conversation
        delete configData[nameToDelete];
        
        // Select the first available conversation
        const remainingConversations = Object.keys(configData);
        currentConversationName = remainingConversations[0] || null;
        
        // Update dropdown
        updateDropdown();
        
        // Close modal
        const modal = bootstrap.Modal.getInstance(document.getElementById('deleteConversationModal'));
        modal.hide();
        
        // Render the new current conversation
        if (currentConversationName) {
            renderEditor(currentConversationName);
        }
        
        // Auto-save the changes
        console.log("Auto-saving after deletion...");
        fetch('/save_config', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(configData, null, 2),
        })
        .then(response => {
            if (!response.ok) {
                return response.json().then(err => { throw new Error(err.message || 'An unknown error occurred.') });
            }
            return response.json();
        })
        .then(data => {
            console.log('Conversation deleted and saved successfully:', data);
            // Show success message
            const deleteBtn = document.getElementById('delete-conversation-btn');
            const originalText = deleteBtn.innerHTML;
            deleteBtn.innerHTML = '<i class="fas fa-check"></i> Deleted!';
            setTimeout(() => {
                deleteBtn.innerHTML = originalText;
            }, 2000);
        })
        .catch((error) => {
            console.error('Error saving after deletion:', error);
            alert('The conversation was deleted but could not be saved automatically. Please click "Save Configuration" to save it manually. Error: ' + error.message);
        });
    }
</script>

<!-- New Conversation Modal -->
<div class="modal fade" id="newConversationModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content" style="background: var(--card-bg); border: 1px solid var(--glass-border);">
            <div class="modal-header" style="border-bottom: 1px solid var(--glass-border);">
                <h5 class="modal-title" style="color: var(--text-primary);">
                    <i class="fas fa-plus-circle"></i> Create New Conversation
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close" style="filter: invert(1);"></button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label for="new-conversation-name" class="form-label">Conversation Name</label>
                    <input type="text" class="form-control" id="new-conversation-name" placeholder="Enter a unique name for the conversation">
                    <div class="form-text" style="color: var(--text-secondary);">This name will be used to identify your conversation configuration.</div>
                </div>
            </div>
            <div class="modal-footer" style="border-top: 1px solid var(--glass-border);">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="confirm-create-conversation">Create</button>
            </div>
        </div>
    </div>
</div>

<!-- Edit Conversation Modal -->
<div class="modal fade" id="editConversationModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content" style="background: var(--card-bg); border: 1px solid var(--glass-border);">
            <div class="modal-header" style="border-bottom: 1px solid var(--glass-border);">
                <h5 class="modal-title" style="color: var(--text-primary);">
                    <i class="fas fa-edit"></i> Edit Conversation Name
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close" style="filter: invert(1);"></button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label for="edit-conversation-name" class="form-label">New Conversation Name</label>
                    <input type="text" class="form-control" id="edit-conversation-name" placeholder="Enter new name for the conversation">
                    <div class="form-text" style="color: var(--text-secondary);">Current name: <span id="current-conversation-name"></span></div>
                </div>
            </div>
            <div class="modal-footer" style="border-top: 1px solid var(--glass-border);">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="confirm-edit-conversation">Save Changes</button>
            </div>
        </div>
    </div>
</div>

<!-- Delete Conversation Modal -->
<div class="modal fade" id="deleteConversationModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content" style="background: var(--card-bg); border: 1px solid var(--glass-border);">
            <div class="modal-header" style="border-bottom: 1px solid var(--glass-border);">
                <h5 class="modal-title" style="color: var(--text-primary);">
                    <i class="fas fa-exclamation-triangle" style="color: var(--danger-red);"></i> Delete Conversation
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close" style="filter: invert(1);"></button>
            </div>
            <div class="modal-body">
                <p style="color: var(--text-primary);">Are you sure you want to delete the conversation "<strong id="delete-conversation-name"></strong>"?</p>
                <p class="text-danger">This action cannot be undone.</p>
            </div>
            <div class="modal-footer" style="border-top: 1px solid var(--glass-border);">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-danger" id="confirm-delete-conversation">Delete</button>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

<!-- New Conversation Modal -->
<div class="modal fade" id="newConversationModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content" style="background: var(--card-bg); border: 1px solid var(--glass-border);">
            <div class="modal-header" style="border-bottom: 1px solid var(--glass-border);">
                <h5 class="modal-title" style="color: var(--text-primary);">
                    <i class="fas fa-plus-circle"></i> Create New Conversation
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close" style="filter: invert(1);"></button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label for="new-conversation-name" class="form-label">Conversation Name</label>
                    <input type="text" class="form-control" id="new-conversation-name" placeholder="Enter a unique name for the conversation">
                    <div class="form-text" style="color: var(--text-secondary);">This name will be used to identify your conversation configuration.</div>
                </div>
            </div>
            <div class="modal-footer" style="border-top: 1px solid var(--glass-border);">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="confirm-create-conversation">Create</button>
            </div>
        </div>
    </div>
</div>

<!-- Edit Conversation Modal -->
<div class="modal fade" id="editConversationModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content" style="background: var(--card-bg); border: 1px solid var(--glass-border);">
            <div class="modal-header" style="border-bottom: 1px solid var(--glass-border);">
                <h5 class="modal-title" style="color: var(--text-primary);">
                    <i class="fas fa-edit"></i> Edit Conversation Name
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close" style="filter: invert(1);"></button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label for="edit-conversation-name" class="form-label">New Conversation Name</label>
                    <input type="text" class="form-control" id="edit-conversation-name" placeholder="Enter new name for the conversation">
                    <div class="form-text" style="color: var(--text-secondary);">Current name: <span id="current-conversation-name"></span></div>
                </div>
            </div>
            <div class="modal-footer" style="border-top: 1px solid var(--glass-border);">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="confirm-edit-conversation">Save Changes</button>
            </div>
        </div>
    </div>
</div>

<!-- Delete Conversation Modal -->
<div class="modal fade" id="deleteConversationModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content" style="background: var(--card-bg); border: 1px solid var(--glass-border);">
            <div class="modal-header" style="border-bottom: 1px solid var(--glass-border);">
                <h5 class="modal-title" style="color: var(--text-primary);">
                    <i class="fas fa-exclamation-triangle" style="color: var(--danger-red);"></i> Delete Conversation
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close" style="filter: invert(1);"></button>
            </div>
            <div class="modal-body">
                <p style="color: var(--text-primary);">Are you sure you want to delete the conversation "<strong id="delete-conversation-name"></strong>"?</p>
                <p class="text-danger">This action cannot be undone.</p>
            </div>
            <div class="modal-footer" style="border-top: 1px solid var(--glass-border);">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-danger" id="confirm-delete-conversation">Delete</button>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html> 
